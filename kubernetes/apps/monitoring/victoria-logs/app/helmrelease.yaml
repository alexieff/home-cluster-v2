---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: victoria-logs
spec:
  chart:
    spec:
      chart: victoria-logs-single
      version: 0.x
      sourceRef:
        kind: HelmRepository
        name: victoria-metrics
  interval: 1h
  values:
    server:
      enabled: true
      name: server-logs
      persistentVolume:
        enabled: true
        storageClass: longhorn
        size: 512Gi
      retentionPeriod: "30d"
      service:
        servicePort: 9428
        type: ClusterIP
      resources:
        requests:
          cpu: 100m
          memory: 256Mi
        limits:
          memory: 1Gi
      securityContext:
        enabled: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000

    fluent-bit:
      enabled: true
      config:
        service: |
          [SERVICE]
              Daemon Off
              Flush 1
              Log_Level info
              Parsers_File parsers.conf
              Parsers_File custom_parsers.conf
              HTTP_Server On
              HTTP_Listen 0.0.0.0
              HTTP_Port 2020
              Health_Check On

        inputs: |
          [INPUT]
              Name tail
              Path /var/log/containers/*.log
              multiline.parser docker, cri
              Tag kube.*
              Mem_Buf_Limit 5MB
              Skip_Long_Lines On

          [INPUT]
              Name systemd
              Tag host.*
              Systemd_Filter _SYSTEMD_UNIT=kubelet.service
              Read_From_Tail On

        filters: |
          [FILTER]
              Name kubernetes
              Match kube.*
              Kube_URL https://kubernetes.default.svc:443
              Kube_CA_File /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
              Kube_Token_File /var/run/secrets/kubernetes.io/serviceaccount/token
              Kube_Tag_Prefix kube.var.log.containers.
              Merge_Log On
              Keep_Log Off
              K8S-Logging.Parser On
              K8S-Logging.Exclude On

          [FILTER]
              Name nest
              Match kube.*
              Operation lift
              Nested_under kubernetes
              Add_prefix k8s_

        outputs: |
          [OUTPUT]
              Name http
              Match kube.*
              URI /insert/jsonline?_stream_fields=stream,k8s_namespace_name,k8s_pod_name,k8s_container_name&_msg_field=log&_time_field=date
              Host victoria-logs-server
              Port 9428
              compress gzip
              format json_lines
              json_date_format iso8601
              header AccountID 0
              header ProjectID 0

          [OUTPUT]
              Name http
              Match host.*
              URI /insert/jsonline?_stream_fields=stream,hostname&_msg_field=MESSAGE&_time_field=date
              Host victoria-logs-server
              Port 9428
              compress gzip
              format json_lines
              json_date_format iso8601
              header AccountID 0
              header ProjectID 0

      resources:
        requests:
          cpu: 50m
          memory: 64Mi
        limits:
          memory: 256Mi
