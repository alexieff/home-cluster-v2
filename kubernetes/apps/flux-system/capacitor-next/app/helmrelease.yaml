---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: capacitor-next
  namespace: flux-system
spec:
  interval: 1h
  timeout: 15m
  chart:
    spec:
      chart: ./self-host/charts/capacitor-next
      sourceRef:
        kind: GitRepository
        name: capacitor-next
        namespace: flux-system
      interval: 1h
  values:
    image:
      repository: ghcr.io/gimlet-io/capacitor-next
      tag: v2025-12.1-rc2
      pullPolicy: IfNotPresent

    replicaCount: 1

    service:
      type: ClusterIP
      port: 80
      targetPort: 8080

    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 500m
        memory: 512Mi

    serviceAccount:
      create: true
      name: capacitor-next

    rbac:
      create: true
      createImpersonatorRole: true

    # Authentication: noauth for internal access
    auth:
      method: noauth

    # Authorization: impersonation rules
    authorization:
      impersonateSaRules: "noauth=flux-system:capacitor-next-builtin-editor"

    # Use secrets from ExternalSecret
    existingSecret:
      name: capacitor-next-credentials

    # Cluster configuration - in-cluster access
    clusters:
      - id: in-cluster
        name: In-cluster
        apiServerURL: https://kubernetes.default.svc
        certificateAuthorityFile: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
        serviceAccount:
          tokenFile: /var/run/secrets/kubernetes.io/serviceaccount/token

    # Security context
    securityContext:
      enabled: true
      pod:
        runAsNonRoot: true
        runAsUser: 1000
        seccompProfile:
          type: RuntimeDefault
      container:
        allowPrivilegeEscalation: false
        readOnlyRootFilesystem: true
        capabilities:
          drop:
            - ALL

    # Ingress disabled - we'll use HTTPRoute
    ingress:
      enabled: false
