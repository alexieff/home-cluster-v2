---
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: jetkvm-cloud-api
  namespace: default
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: ClusterSecretStore
    name: onepassword
  target:
    name: jetkvm-cloud-api
    template:
      engineVersion: v2
      data:
        # Application port
        PORT: "3000"

        # Database connection - uses CNPG read-write service
        DATABASE_URL: "postgresql://jetkvm:{{ .dbPassword }}@jetkvm-postgres-rw.default.svc.cluster.local:5432/jetkvm?schema=public"

        # Google OAuth Configuration
        GOOGLE_CLIENT_ID: "{{ .googleClientId }}"
        GOOGLE_CLIENT_SECRET: "{{ .googleClientSecret }}"

        # Hostnames
        API_HOSTNAME: "{{ .apiHostname }}"
        APP_HOSTNAME: "{{ .appHostname }}"

        # Cloudflare TURN Service
        CLOUDFLARE_TURN_ID: "{{ .cfTurnId }}"
        CLOUDFLARE_TURN_TOKEN: "{{ .cfTurnToken }}"

        # Session Cookie Secret
        COOKIE_SECRET: "{{ .cookieSecret }}"

        # S3 Compatible Storage (R2)
        R2_ENDPOINT: "{{ .r2Endpoint }}"
        R2_ACCESS_KEY_ID: "{{ .r2AccessKeyId }}"
        R2_SECRET_ACCESS_KEY: "{{ .r2SecretAccessKey }}"
        R2_BUCKET: "{{ .r2Bucket }}"
        R2_CDN_URL: "{{ .r2CdnUrl }}"

        # CORS Origins
        CORS_ORIGINS: "{{ .corsOrigins }}"

        # Real IP Header
        REAL_IP_HEADER: "X-Forwarded-For"

        # ICE Servers for WebRTC
        ICE_SERVERS: "{{ .iceServers }}"
  data:
    - secretKey: dbPassword
      remoteRef:
        key: jetkvm-postgres
        property: password
    - secretKey: googleClientId
      remoteRef:
        key: jetkvm-cloud-api
        property: google_client_id
    - secretKey: googleClientSecret
      remoteRef:
        key: jetkvm-cloud-api
        property: google_client_secret
    - secretKey: apiHostname
      remoteRef:
        key: jetkvm-cloud-api
        property: api_hostname
    - secretKey: appHostname
      remoteRef:
        key: jetkvm-cloud-api
        property: app_hostname
    - secretKey: cfTurnId
      remoteRef:
        key: jetkvm-cloud-api
        property: cloudflare_turn_id
    - secretKey: cfTurnToken
      remoteRef:
        key: jetkvm-cloud-api
        property: cloudflare_turn_token
    - secretKey: cookieSecret
      remoteRef:
        key: jetkvm-cloud-api
        property: cookie_secret
    - secretKey: r2Endpoint
      remoteRef:
        key: jetkvm-cloud-api
        property: r2_endpoint
    - secretKey: r2AccessKeyId
      remoteRef:
        key: jetkvm-cloud-api
        property: r2_access_key_id
    - secretKey: r2SecretAccessKey
      remoteRef:
        key: jetkvm-cloud-api
        property: r2_secret_access_key
    - secretKey: r2Bucket
      remoteRef:
        key: jetkvm-cloud-api
        property: r2_bucket
    - secretKey: r2CdnUrl
      remoteRef:
        key: jetkvm-cloud-api
        property: r2_cdn_url
    - secretKey: corsOrigins
      remoteRef:
        key: jetkvm-cloud-api
        property: cors_origins
    - secretKey: iceServers
      remoteRef:
        key: jetkvm-cloud-api
        property: ice_servers
